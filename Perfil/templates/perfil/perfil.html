{% extends 'pets/base.html' %}
{% load static %}

{% block title %}Perfil de {{ perfil.user.username }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <div class="text-center mb-5">

                {% if perfil.avatar %}
                    <img src="{{ perfil.avatar.url }}"
                         alt="{{ perfil.user.username }}"
                         class="rounded-circle shadow"
                         width="150" height="150"
                         style="object-fit: cover;">
                {% else %}
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow mx-auto"
                         style="width: 150px; height: 150px; font-size: 4rem;">
                        {{ perfil.user.username|first|upper }}
                    </div>
                {% endif %}

                <h1 class="mt-4 fw-bold">
                    {{ perfil.user.get_full_name|default:perfil.user.username }}
                </h1>

                <p class="text-muted fs-5">@{{ perfil.user.username }}</p>

                {% if perfil.location %}
                    <p class="text-muted">
                        <strong>De: </strong> {{ perfil.location }}
                    </p>
                {% endif %}

                {% if user.is_authenticated and perfil.user == user %}
                <button class="btn btn-outline-primary btn-lg mt-3"
                        data-bs-toggle="modal" data-bs-target="#editModal">
                    Editar perfil
                </button>
                {% endif %}
            </div>

            <hr class="my-5">

            <h3 class="fw-bold mb-4">
                Mascotas de {{ perfil.user.username }} ({{ perfil.user.pets.count }})
            </h3>

            {% if perfil.user.pets.exists %}
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    {% for pet in perfil.user.pets.all %}
                    <div class="col">
                        <a href="{% url 'adopt_me' pet.pk %}" class="text-decoration-none">
                            <div class="card h-100 shadow-sm">
                                <div style="height: 220px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    {% if pet.image %}
                                        <img src="{{ pet.image.url }}" class="img-fluid" style="max-height: 210px;">
                                    {% else %}
                                        <span class="text-muted">Sin foto</span>
                                    {% endif %}
                                </div>
                                <div class="card-body text-center">
                                    <h5 class="card-title">{{ pet.name }}</h5>
                                    <span class="badge bg-{% if pet.status == 'adoptado' %}success{% else %}warning text-dark{% endif %}">
                                        {{ pet.get_status_display }}
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>

            {% else %}
                <div class="text-center py-5">
                    <p class="text-muted fs-4">
                        Este usuario aún no ha publicado mascotas.
                    </p>

                    {% if user.is_authenticated and perfil.user == user %}
                        <a href="{% url 'add_pet' %}" class="btn btn-success btn-lg">
                            Publicar mi primera mascota
                        </a>
                    {% endif %}
                </div>
            {% endif %}

        </div>
    </div>
</div>


{% if user.is_authenticated and perfil.user == user %}
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <form method="post" enctype="multipart/form-data" action="{% url 'edit_profile' %}">
                {% csrf_token %}

                <div class="modal-header">
                    <h5 class="modal-title">Editar perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <div class="mb-3 text-center">
                        <img src="{% if perfil.avatar %}{{ perfil.avatar.url }}{% else %}{% static 'img/Logo.png' %}{% endif %}"
                             class="rounded-circle" width="100" height="100" id="preview">

                        <br><br>
                        <input type="file" name="avatar" accept="image/*" class="form-control"
                               onchange="document.getElementById('preview').src = window.URL.createObjectURL(this.files[0])">
                    </div>

                    <input type="text" name="first_name" class="form-control mb-3"
                           placeholder="Nombre" value="{{ perfil.user.first_name }}">

                    <input type="text" name="last_name" class="form-control mb-3"
                           placeholder="Apellido" value="{{ perfil.user.last_name }}">

                    <input type="text" name="location" class="form-control mb-3"
                           placeholder="Ciudad, País" value="{{ perfil.location|default:'' }}">

                    <input type="date" name="birth_date" class="form-control"
                           value="{{ perfil.birth_date|date:'Y-m-d'|default:'' }}">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>

            </form>

        </div>
    </div>
</div>
{% endif %}
{% endblock %}
